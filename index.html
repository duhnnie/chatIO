<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>Chat HTML</title>
        <style>
            @font-face {
                font-family: 'abeezeeregular';
                src: url('fonts/abeezee-regular-webfont.woff2') format('woff2'),
                     url('fonts/abeezee-regular-webfont.woff') format('woff');
                font-weight: normal;
                font-style: normal;

            }
            body, button, input {
                font-family: 'abeezeeregular';
            }
            body {
                margin: auto;

            }
            #container {
                background: #F8F8f8;
                height: 770px;
                display: flex;
                flex-direction: column;
                flex-wrap: nowrap;
            }
            #header {
                background: #444444;
                flex: 0 1 auto;
                display: flex;
                align-items: center;
                justify-content: space-between;
                color: beige;
            }
            #header > * {
                margin: 3px 20px;
            }
            #avatar {
                display: flex;
                align-items: center;
            }
            #username {
                margin: 0 10px;
            }
            #user-picture,
            .user-icon {
                text-align: center;
                vertical align: center;
                color: white;
            }
            #user-picture {
                width: 60px;
                height: 60px;
                border: 2px solid #d0d0d0;
                border-radius: 100%;
                display: inline-block;
                line-height: 60px;
            }
            #body {
                background: #888888;
                flex: 1 1 auto;
                display: flex;
                flex-direction: row;
            }
            #messages,
            #users {
                margin: 0;
                list-style: none;
                padding: 0px;
                overflow-x: hidden;
                overflow-y: auto;
            }
            #messages {
                flex: 70 1 auto;
            }
            #messages li {
                background: #ccc;
                font-size: 14px;
                padding: 1em;
                margin: 1em 0;
            }
            #messages datetime {
                font-size: .7em;
                float: right;
            }
            #users {
                max-width: 30%;
                background: #666666;
                flex: 30 1 auto;
                color: azure;
            }
            #footer {
                background: black;
                flex: 0 1 auto;
            }
            #message-input {
                width: 90%;
                font-size: 16px;
                padding: .5em;
                color: beige;
                background: black;
                border: none;
            }
            #send-button {
                width: 8%;
                border: none;
                box-sizing: border-box;
                margin: 0;
                padding: 11px;
                font-size: 12px;
                background: tomato;
                color: white
            }
            .author {
                font-weight: bold;
                font-size: 1.2em;
                margin-bottom: 0.3em;
            }
            .circle {
                border-radius: 100%;
            }
            .user-avatar {
                padding: 5px;
                height: auto;
                display: flex;
                flex-direction: row;
                align-items: center;
            }
            .user-avatar .user-icon {
                height: 50px;
                width: 50px;
                line-height: 50px;
            }
            .user-avatar span {
                margin-left: 0.5em;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .notification {
                font-style: italic;
            }
        </style>
    </head>
    <body>
        <div id="container">
            <header id="header">
                <h1 id="title">Chat.io</h1>
                <div id="avatar">
                    <span id="username"></span>
                </div>

            </header>
            <div id="body">
                <ul id="messages"></ul>
                <ul id="users"></ul>
            </div>
            <footer id="footer">
                <form>
                    <input id="message-input" placeholder="Escribe aqu&iacute;" type="text"/>
                    <button id="send-button">Enviar</button>
                </form>
            </footer>
        </div>
        <script src="/socket.io/socket.io.js"></script>
        <script type="text/javascript">
            var socket,
                nickname,
                list,
                input,
                container,
                usersList,
                colorsA = [ "tomato", "gold", "turquoise", "palevioletred", "orange", "cornflowerblue"],
                colorsB = [],
                colorsTarget = colorsA,
                isTyping = false,
                typing= [],
                timeoutHandler,
                users = {},
                MESSAGE_TYPE = {
                    MESSAGE: 1,
                    CONNECTED: 2,
                    ONLINE: 3,
                    DISCONNECTED: 4,
                    TYPING: 5
                };

            function formatNickname(nickname) {
                return nickname.match(/\b(\w)/g).slice(0, 2).join("").toUpperCase();
            }

            function getColor () {
                var index,
                    selectedColor,
                    otherColors;

                if (colorsTarget.length === 0) {
                    colorsTarget = colorsTarget === colorsA ? colorsB : colorsA;
                }

                otherColors = colorsTarget === colorsA ? colorsB : colorsA;

                index = Math.round(Math.random() * colorsTarget.length - 1);
                selectedColor = colorsTarget.splice(index, 1)[0];
                otherColors.push(selectedColor);
                console.log(colorsA, colorsB);
                return selectedColor;
            };

            function initAvatar() {
                var div = document.createElement('div');
                div.className = 'circle';
                div.id = "user-picture";
                div.style.backgroundColor = users[nickname].color;
                div.appendChild(document.createTextNode(formatNickname(nickname)));
                document.getElementById('avatar').appendChild(div);
                document.getElementById('username').appendChild(document.createTextNode(nickname));
            }

            function appendMessage(type, message) {
                var textNode,
                    messageHTML,
                    content = [],
                    datetime,
                    span,
                    color,
                    aux;

                datetime = document.createElement('datetime');
                datetime.datetime = datetime.textContent = (message && message.datetime) || "2016-08-12";

                switch (type) {
                    case MESSAGE_TYPE.ONLINE:
                        textNode = document.createTextNode("EstÃ¡s connectado!");
                        span = document.createElement('span');
                        span.appendChild(textNode);
                        aux = document.createElement('div');
                        aux.className = 'notification';
                        aux.appendChild(span);
                        aux.appendChild(datetime);
                        content.push(aux);
                        break;
                    case MESSAGE_TYPE.MESSAGE:
                        aux = document.createElement('div');
                        aux.className = "author";
                        aux.appendChild(document.createTextNode(message.user));
                        content.push(aux);
                        span = document.createElement('span');
                        span.appendChild(document.createTextNode(message.text));
                        aux = document.createElement('div');
                        aux.appendChild(span);
                        aux.appendChild(datetime);
                        aux.className = "message-content";
                        content.push(aux);
                        color = users[message.user].color;
                        break;
                    case MESSAGE_TYPE.CONNECTED:
                        aux = document.createElement('strong');
                        aux.appendChild(document.createTextNode(message.user));
                        span = document.createElement('span');
                        span.appendChild(aux);
                        span.appendChild(document.createTextNode(" se ha unido a la sala de chat."));
                        aux = document.createElement('div');
                        aux.className = 'notification';
                        aux.appendChild(span);
                        aux.appendChild(datetime);
                        content.push(aux);
                        color = users[message.user].color;
                        break;
                    case MESSAGE_TYPE.DISCONNECTED:
                        aux = document.createElement('strong');
                        aux.appendChild(document.createTextNode(message.user));
                        span = document.createElement('span');
                        span.appendChild(aux);
                        span.appendChild(document.createTextNode(" ha dejado la sala de chat."));
                        aux = document.createElement('div');
                        aux.className = 'notification';
                        aux.appendChild(span);
                        aux.appendChild(datetime);
                        content.push(aux);
                        color = users[message.user].color;
                        break;
                    case MESSAGE_TYPE.TYPING:
                        if (typing.length) {
                            span = document.createElement('span');
                            aux = document.createElement('strong');
                            aux.appendChild(document.createTextNode(typing.join(', ')));
                            span.appendChild(aux);
                            span.appendChild(document.createTextNode((typing.length > 1 ? ' are' : ' is') + ' typing...'));

                            content.push(span);
                        } else {
                            (aux = document.getElementById('typing_notification')) ? aux.remove() : '';
                            return;
                        }
                        break;
                }

                if (type === MESSAGE_TYPE.TYPING) {
                    messageHTML = document.getElementById('typing_notification');
                }

                if (!messageHTML) {
                    messageHTML = document.createElement('li');
                    messageHTML.id = type === MESSAGE_TYPE.TYPING ? 'typing_notification' : '';
                } else {
                    while (messageHTML.hasChildNodes()) {
                        messageHTML.childNodes[0].remove();
                    }
                }

                content.forEach(function (item) {
                    messageHTML.appendChild(item);
                });

                list.appendChild(messageHTML);
                messageHTML.style.backgroundColor = color;
                list.scrollTop = list.scrollHeight;
            }

            function updateChatSize() {
                container.style.width = window.innerWidth + "px";
                container.style.height = window.innerHeight + "px";
            }

            function addUserToList(nickname) {
                var li = document.createElement('li'),
                    div = document.createElement('div'),
                    avatar = document.createElement('div'),
                    span = document.createElement('span');

                users[nickname] = {
                    color: getColor()
                };

                div.className = 'user-avatar';
                avatar.className = 'circle user-icon';
                avatar.appendChild(document.createTextNode(formatNickname(nickname)));
                span.appendChild(document.createTextNode(nickname));

                div.appendChild(avatar);
                div.appendChild(span);
                li.appendChild(div);

                li.id = "user-" + nickname;
                avatar.style.backgroundColor = users[nickname].color;

                usersList.appendChild(li);
            };

            function setUsersList(users) {
                while (usersList.hasChildNodes()) {
                    usersList.childNodes[0].remove();
                }
                users.forEach(function (item) {
                    addUserToList(item);
                });
            }

            document.addEventListener('DOMContentLoaded', function () {
                nickname = prompt("Enter your nickname:");
                socket = io(undefined, {query: "nickname=" + nickname});

                socket.on('error', function (errorMsg) {
                    console.error(errorMsg);
                    alert(errorMsg);
                });

                socket.on('connect', function () {
                    users[nickname] = {
                        color: getColor()
                    }
                    initAvatar();
                    appendMessage(MESSAGE_TYPE.ONLINE);

                    socket.on('typing', function (data) {
                        typing.push(data.user);
                        appendMessage(MESSAGE_TYPE.TYPING);
                    });

                    socket.on('stop typing', function (data) {
                        typing = typing.filter(function (user) {
                            return user != data.user;
                        });
                        appendMessage(MESSAGE_TYPE.TYPING);
                    });
                });

                socket.on('disconnect', function () {
                    users = {};
                });

                socket.on('chat message', function (message) {
                    appendMessage(MESSAGE_TYPE.MESSAGE, message);
                });

                socket.on('user connected', function (data) {
                    addUserToList(data.user);
                    appendMessage(MESSAGE_TYPE.CONNECTED, data);
                });

                socket.on('user disconnect', function (data) {
                    appendMessage(MESSAGE_TYPE.DISCONNECTED, data);
                    typing = typing.filter(function (user) {
                        return user != data.user;
                    });
                    document.getElementById('user-' + data.user).remove();
                });

                socket.on('users_list', function (data) {
                    setUsersList(data);
                });

                document.querySelector('form').addEventListener('submit', function (e) {
                    e.preventDefault();
                    socket.emit('stop typing');
                    socket.emit('chat message', input.value);
                    input.value = '';
                    clearTimeout(timeoutHandler);
                    isTyping = false;
                });

                window.addEventListener('resize', function () {
                    updateChatSize();
                });

                list = document.querySelector('#messages');
                input = document.getElementById('message-input');
                container = document.getElementById('container');
                usersList = document.getElementById('users');

                input.addEventListener('input', function () {
                    if (!isTyping) {
                        isTyping = true;
                        socket.emit('typing');
                    }
                    clearTimeout(timeoutHandler);
                    timeoutHandler = setTimeout(function () {
                        isTyping = false;
                        socket.emit('stop typing');
                    }, 3000);
                });

                updateChatSize();
            });

        </script>
    </body>
</html>